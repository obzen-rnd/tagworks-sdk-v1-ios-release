//
//  EventSerializer.swift
//  TagWorks-iOS-v1
//
//  Created by Digital on 7/22/24.
//

import Foundation

/// Î°úÍ∑∏ ÏÜ°Ïã†ÏùÑ ÏúÑÌïú ÏßÅÎ†¨Ìôî Ïù∏ÌÑ∞ÌéòÏù¥Ïä§Î•º ÏÉÅÏÜçÎ∞õÎäî Íµ¨ÌòÑÏ≤¥ ÌÅ¥ÎûòÏä§ÏûÖÎãàÎã§.
final class EventSerializer: Serializer {
    
    /// Ïù¥Î≤§Ìä∏ Íµ¨Ï°∞Ï≤¥Ïóê Ï†ÄÏû•Îêú ÌîÑÎ°úÌçºÌã∞Î•º String ÌòïÌÉúÏùò MapÏúºÎ°ú Î∞òÌôòÌï©ÎãàÎã§.
    /// - Parameter event: Ïù¥Î≤§Ìä∏ Íµ¨Ï°∞Ï≤¥
    /// - Returns: Ïù¥Î≤§Ìä∏ ÌîÑÎ°úÌçºÌã∞ Map
    internal func queryItems(for event: Event) -> [String : String] {
        event.queryItems.reduce(into: [String : String]()) {
            $0[$1.name] = $1.value
        }
    }
    
    internal func queryItemsWithLocalQueue(for event: Event) -> [String : String] {
        event.queryItemsWithLocalQueue.reduce(into: [String : String]()) {
            $0[$1.name] = $1.value
        }
    }
    
    /// queueÏóêÏÑú Ïù¥Î≤§Ìä∏ Íµ¨Ï°∞Ï≤¥Î•º Î∞òÌôòÌï©ÎãàÎã§.
    /// - Parameter events: Ïù¥Î≤§Ìä∏ Íµ¨Ï°∞Ï≤¥ Ïª¨Î†âÏÖò
    /// - Returns: Json Data
    internal func toJsonData(for events: [Event], isLocalQueue: Bool = false) throws -> Data {
        let eventsAsQueryItems: [[String: String]] = events.map { isLocalQueue == false ? self.queryItems(for: $0) : self.queryItemsWithLocalQueue(for: $0) }
        let serializedEvents = eventsAsQueryItems.map { items in
            items.map {
                "\($0.key)=\($0.value)"
            }.joined(separator: "&")
        }
    
        let body: [String : [String]]  = ["requests": serializedEvents.map({ "?\($0)" })]
//        print("üíÅ‚Äç‚ôÇÔ∏è[TagWorks v\(CommonUtil.getSDKVersion()!)] Event Json Data: \(body)")
    
        // JSONSerialization.data(withJSONObject:) Ìï®ÏàòÎ•º ÏÇ¨Ïö©ÌïòÎ©¥ ÏïàÏ†ÑÌïú JSON ÏÇ¨Ïö©ÏùÑ ÏúÑÌï¥ '\','\\' Î¨∏ÏûêÍ∞Ä ÏûêÎèôÏúºÎ°ú Î∂ôÏñ¥ÏÑú Ïù∏ÏΩîÎî© Îê®.
        return try JSONSerialization.data(withJSONObject: body, options: [])
    }
}

fileprivate extension Event {
    
    /// Tag Ïù¥Î≤§Ìä∏ Ï†ïÎ≥¥Î•º ÏßÅÎ†¨Ìôî Ìï©ÎãàÎã§.
    /// - Returns: Tag Ïù¥Î≤§Ìä∏ Î°úÍ∑∏
    private func serializeEventString() -> String {
        var eventCommonItems: [URLQueryItem] = []
        eventCommonItems.append(URLQueryItem(name: EventParams.clientDateTime, value: CommonUtil.Formatter.iso8601DateFormatter.string(from: clientDateTime)))
        eventCommonItems.append(URLQueryItem(name: EventParams.triggerType, value: eventType))
        eventCommonItems.append(URLQueryItem(name: EventParams.visitorId, value: visitorId))
        
        if pageTitle != nil {
            eventCommonItems.append(URLQueryItem(name: EventParams.pageTitle, value: pageTitle))
        }
        if searchKeyword != nil {
            eventCommonItems.append(URLQueryItem(name: EventParams.searchKeyword, value: searchKeyword))
        }
        if customUserPath != nil {
            eventCommonItems.append(URLQueryItem(name: EventParams.customUserPath, value: customUserPath))
        }
        if errorMsg != nil {
            eventCommonItems.append(URLQueryItem(name: EventParams.errorMessage, value: errorMsg))
        }

        eventCommonItems.append(URLQueryItem(name: EventParams.deviceType, value: "app"))
        eventCommonItems.append(URLQueryItem(name: EventParams.appVersion, value: TagWorks.sharedInstance.appVersion ?? AppInfo.getBundleShortVersion()))
        eventCommonItems.append(URLQueryItem(name: EventParams.appName, value: TagWorks.sharedInstance.appName ?? AppInfo.getBundleName()))
        
        // index Í∏∞Î∞ò ÎîîÎ©òÏ†ºÏù∏ÏßÄ ÎèôÏ†Å ÌååÎùºÎØ∏ÌÑ∞Ïù∏ÏßÄ Ïó¨Î∂Ä ÌåêÎ≥Ñ ÌõÑ Î∂ÑÍ∏∞
        var customDimensionItems: [URLQueryItem] = []
        if TagWorks.sharedInstance.isUseDynamicParameter == false {
            var dimensionIndex = 0
            var lastDimension: [Dimension] = []
            for dimension in self.dimensions {
                // ÏµúÎåÄ Ïù∏Îç±Ïä§Î•º Í∞ÄÏ†∏Ïò¥
                if dimensionIndex <= dimension.index {
                    dimensionIndex = dimension.index
                }
                
                if dimension.index != -1 {
                    if dimension.type == Dimension.generalType {
                        customDimensionItems.append(URLQueryItem(name: EventParams.customDimensionD + "\(dimension.index)", value: dimension.value))
                    } else if dimension.type == Dimension.factType {
                        customDimensionItems.append(URLQueryItem(name: EventParams.customDimensionF + "\(dimension.index)", value: String(dimension.numValue)))
                    }
                } else {
                    lastDimension.append(dimension)
                }
            }
            // Ï†ïÏ†Å ÎîîÎ©òÏ†ºÏù¥ ÏïÑÎãå ÎèôÏ†Å ÎîîÎ©òÏ†ºÏùÑ ÏÇ¨Ïö©Ìï¥ÏÑú Ï∂îÍ∞ÄÌïú Í≤ΩÏö∞ ÏòàÏô∏ Ï≤òÎ¶¨
            if lastDimension.isEmpty == false {
                for dimension in lastDimension {
                    dimensionIndex += 1
                    
                    if dimension.key != "" {
                        if dimension.type == Dimension.generalType {
                            customDimensionItems.append(URLQueryItem(name: EventParams.customDimensionD + "\(dimensionIndex)", value: dimension.value))
                        } else if dimension.type == Dimension.factType {
                            customDimensionItems.append(URLQueryItem(name: EventParams.customDimensionF + "\(dimensionIndex)", value: String(dimension.numValue)))
                        }
                    }
                }
            }
            
            
//            customDimensionItems = dimensions.map {
//                if $0.type == Dimension.generalType {
//                    URLQueryItem(name: EventParams.customDimensionD + "\($0.index)", value: $0.value)
//                } else {
//                    URLQueryItem(name: EventParams.customDimensionF + "\($0.index)", value: String($0.numValue))
//                }
//            }
        } else {
            // ÎèôÏ†Å ÌååÎùºÎØ∏ÌÑ∞
            customDimensionItems.append(URLQueryItem(name: EventParams.dynamicDimension, value: convertJsonStringWithDynamicCommonDimensions()))
        }
        let eventsAsQueryItems = eventCommonItems + customDimensionItems
        let serializedEvents = eventsAsQueryItems.reduce(into: [String:String]()) {
            $0[$1.name] = $1.value
        }
        return serializedEvents.map{
            "\($0.key)‚â°\($0.value)"
        }.joined(separator: "‚àû")
    }
    
    private func serializeAppInfo() -> String {
        var eventCommonItems: [URLQueryItem] = []
        eventCommonItems.append(URLQueryItem(name: EventParams.deviceType, value: "app"))
        eventCommonItems.append(URLQueryItem(name: EventParams.appVersion, value: TagWorks.sharedInstance.appVersion ?? AppInfo.getBundleShortVersion()))
        eventCommonItems.append(URLQueryItem(name: EventParams.appName, value: TagWorks.sharedInstance.appName ?? AppInfo.getBundleName()))
        
        let eventsAsQueryItems = eventCommonItems
        let serializedEvents = eventsAsQueryItems.reduce(into: [String:String]()) {
            $0[$1.name] = $1.value
        }
        return serializedEvents.map{
            "\($0.key)‚â°\($0.value)"
        }.joined(separator: "‚àû")
    }
    
    private func serializeCommonDimensions() -> String {
        var customDimensionItems: [URLQueryItem] = []
        var dimensionIndex = 0
        var lastDimension: [Dimension] = []
        for dimension in self.dimensions {
            // ÏµúÎåÄ Ïù∏Îç±Ïä§Î•º Í∞ÄÏ†∏Ïò¥
            if dimensionIndex <= dimension.index {
                dimensionIndex = dimension.index
            }
            
            if dimension.index != -1 {
                if dimension.type == Dimension.generalType {
                    customDimensionItems.append(URLQueryItem(name: EventParams.customDimensionD + "\(dimension.index)", value: dimension.value))
                } else if dimension.type == Dimension.factType {
                    customDimensionItems.append(URLQueryItem(name: EventParams.customDimensionF + "\(dimension.index)", value: String(dimension.numValue)))
                }
            } else {
                lastDimension.append(dimension)
            }
        }
        // Ï†ïÏ†Å ÎîîÎ©òÏ†ºÏù¥ ÏïÑÎãå ÎèôÏ†Å ÎîîÎ©òÏ†ºÏùÑ ÏÇ¨Ïö©Ìï¥ÏÑú Ï∂îÍ∞ÄÌïú Í≤ΩÏö∞ ÏòàÏô∏ Ï≤òÎ¶¨
        if lastDimension.isEmpty == false {
            for dimension in lastDimension {
                dimensionIndex += 1
                
                if dimension.key != "" {
                    if dimension.type == Dimension.generalType {
                        customDimensionItems.append(URLQueryItem(name: EventParams.customDimensionD + "\(dimensionIndex)", value: dimension.value))
                    } else if dimension.type == Dimension.factType {
                        customDimensionItems.append(URLQueryItem(name: EventParams.customDimensionF + "\(dimensionIndex)", value: String(dimension.numValue)))
                    }
                }
            }
        }
//        let customDimensionItems = dimensions.map {
//            if $0.type == Dimension.generalType {
//                URLQueryItem(name: EventParams.customDimensionD + "\($0.index)", value: $0.value)
//            } else {
//                URLQueryItem(name: EventParams.customDimensionF + "\($0.index)", value: String($0.numValue))
//            }
//        }
        let eventsAsQueryItems = customDimensionItems
        let serializedEvents = eventsAsQueryItems.reduce(into: [String:String]()) {
            $0[$1.name] = $1.value
        }
        return serializedEvents.map{
            "\($0.key)‚â°\($0.value)"
        }.joined(separator: "‚àû")
    }
    
    private func serializeDynamicCommonDimensions() -> String {
        var customDimensionItems: [URLQueryItem] = []
        customDimensionItems.append(URLQueryItem(name: EventParams.dynamicDimension, value: convertJsonStringWithDynamicCommonDimensions()))
        
        let eventsAsQueryItems = customDimensionItems
        let serializedEvents = eventsAsQueryItems.reduce(into: [String:String]()) {
            $0[$1.name] = $1.value
        }
        return serializedEvents.map{
            "\($0.key)‚â°\($0.value)"
        }.joined(separator: "‚àû")
    }
    
    // ÎèôÏ†Å ÌååÎùºÎØ∏ÌÑ∞ ÎîîÎ©òÏ†ºÏùÑ jsonStringÏúºÎ°ú Î≥ÄÌôò
    private func convertJsonStringWithDynamicCommonDimensions() -> String {
        var result: [String: Any] = [:]
        var stringDimensions: [String: String] = [:]
        var numericDimensions: [String: String] = [:]
        
        for dimension in self.dimensions {
            if dimension.key != "" {
                if dimension.type == Dimension.generalType {
                    stringDimensions[dimension.key] = dimension.value
                } else if dimension.type == Dimension.factType {
                    numericDimensions[dimension.key] = String(dimension.numValue)
                }
            }
            if dimension.index != -1 {
                if dimension.type == Dimension.generalType {
                    stringDimensions[String(dimension.index)] = dimension.value
                } else if dimension.type == Dimension.factType {
                    numericDimensions[String(dimension.index)] = String(dimension.numValue)
                }
            }
        }
        
//        let stDimension = [EventParams.dynamicDimensionString: stringDimensions]
//        let nuDimension = [EventParams.dynamicDimensionNumeric: numericDimensions]
        result[EventParams.dynamicDimensionString] = stringDimensions
        result[EventParams.dynamicDimensionNumeric] = numericDimensions
        
        do {
            // Dictionary ArrayÎ•º JSONÏúºÎ°ú Î≥ÄÌôò
            let jsonData = try JSONSerialization.data(withJSONObject: result, options: .prettyPrinted)
            
            // JSON Îç∞Ïù¥ÌÑ∞Î•º Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌïòÏó¨ Î∞òÌôò
            if let jsonString = String(data: jsonData, encoding: .utf8) {
                return(jsonString)
            }
        } catch {
            print("JSON Î≥ÄÌôò Ïò§Î•ò: \(error)")
            return ""
        }
        return ""
    }
    
    
    /// URLQuery ÌååÎùºÎØ∏ÌÑ∞Î•º Ï†ÄÏû•ÌïòÎäî Ïª¨Î†âÏÖòÏûÖÎãàÎã§.
    var queryItems: [URLQueryItem] {
        get {
            if let e_c = eventCategory {
                // ÏõπÎ∑∞ÏóêÏÑú Ìò∏Ï∂úÏù¥ ÎêòÏóàÏùÑ Í≤ΩÏö∞, e_c Í∞í Îß® Îí§Ïóê deviceType, AppVersionÍ≥º AppNameÏùÑ ÎçßÎ∂ôÏù∏Îã§.
                // AppÏùò ÏõπÎ∑∞ÏóêÏÑú Î∞úÏÜ°Ìï†Îïå deviceTypeÏùÑ Ï†ÑÏÜ°ÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞, ÌïòÎÇòÏùò Ïù¥Î≤§Ìä∏Î°ú Ïù∏ÏãùÌïòÍ∏∞ ÎïåÎ¨∏Ïóê ÌïÑÌûà Ï∂îÍ∞Ä
                let serializeDimensionString = TagWorks.sharedInstance.isUseDynamicParameter ? serializeDynamicCommonDimensions() : serializeCommonDimensions()
                let eventString = e_c + "‚àû" + serializeDimensionString + "‚àû" + serializeAppInfo()
                return [
                    URLQueryItem(name: URLQueryParams.siteId, value: siteId.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.userId, value: userId?.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.adId, value: adId?.stringByAddingPercentEncoding),
//                    URLQueryItem(name: URLQueryParams.url, value: url?.absoluteString.stringByAddingPercentEncoding),
//                    URLQueryItem(name: URLQueryParams.urlReferer, value: urlReferer?.absoluteString.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.url, value: (url?.absoluteString.decodeUrl())?.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.urlReferer, value: (urlReferer?.absoluteString.decodeUrl())?.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.language, value: language?.addingPercentEncoding(withAllowedCharacters: .alphanumerics)?.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.clientDateTime, value: CommonUtil.Formatter.iso8601DateFormatter.string(from: clientDateTime)),
                    URLQueryItem(name: URLQueryParams.screenSize, value: String(format: "%1.0fx%1.0f", screenResolution.width, screenResolution.height)),
                    URLQueryItem(name: URLQueryParams.event, value: eventString.stringByAddingPercentEncoding),
                ]
            }
            
            return [
                URLQueryItem(name: URLQueryParams.siteId, value: siteId.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.userId, value: userId?.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.adId, value: adId?.stringByAddingPercentEncoding),
//                URLQueryItem(name: URLQueryParams.url, value: url?.absoluteString.stringByAddingPercentEncoding),
//                URLQueryItem(name: URLQueryParams.urlReferer, value: urlReferer?.absoluteString.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.url, value: (url?.absoluteString.decodeUrl())?.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.urlReferer, value: (urlReferer?.absoluteString.decodeUrl())?.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.language, value: language?.addingPercentEncoding(withAllowedCharacters: .alphanumerics)?.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.clientDateTime, value: CommonUtil.Formatter.iso8601DateFormatter.string(from: clientDateTime)),
                URLQueryItem(name: URLQueryParams.screenSize, value: String(format: "%1.0fx%1.0f", screenResolution.width, screenResolution.height)),
                URLQueryItem(name: URLQueryParams.event, value: serializeEventString().stringByAddingPercentEncoding)
            ]
        }
    }
    
    /// URLQuery ÌååÎùºÎØ∏ÌÑ∞Î•º Ï†ÄÏû•ÌïòÎäî Ïª¨Î†âÏÖòÏûÖÎãàÎã§.
    var queryItemsWithLocalQueue: [URLQueryItem] {
        get {
            if let e_c = eventCategory {
                // ÏõπÎ∑∞ÏóêÏÑú Ìò∏Ï∂úÏù¥ ÎêòÏóàÏùÑ Í≤ΩÏö∞, e_c Í∞í Îß® Îí§Ïóê deviceType, AppVersionÍ≥º AppNameÏùÑ ÎçßÎ∂ôÏù∏Îã§.
                // AppÏùò ÏõπÎ∑∞ÏóêÏÑú Î∞úÏÜ°Ìï†Îïå deviceTypeÏùÑ Ï†ÑÏÜ°ÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞, ÌïòÎÇòÏùò Ïù¥Î≤§Ìä∏Î°ú Ïù∏ÏãùÌïòÍ∏∞ ÎïåÎ¨∏Ïóê ÌïÑÌûà Ï∂îÍ∞Ä
                let serializeDimensionString = TagWorks.sharedInstance.isUseDynamicParameter ? serializeDynamicCommonDimensions() : serializeCommonDimensions()
                let eventString = e_c + "‚àû" + serializeDimensionString + "‚àû" + serializeAppInfo() + "‚àû" + "obz_unsent‚â°1"
                return [
                    URLQueryItem(name: URLQueryParams.siteId, value: siteId.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.userId, value: userId?.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.adId, value: adId?.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.url, value: (url?.absoluteString.decodeUrl())?.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.urlReferer, value: (urlReferer?.absoluteString.decodeUrl())?.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.language, value: language?.addingPercentEncoding(withAllowedCharacters: .alphanumerics)?.stringByAddingPercentEncoding),
                    URLQueryItem(name: URLQueryParams.clientDateTime, value: CommonUtil.Formatter.iso8601DateFormatter.string(from: clientDateTime)),
                    URLQueryItem(name: URLQueryParams.screenSize, value: String(format: "%1.0fx%1.0f", screenResolution.width, screenResolution.height)),
                    URLQueryItem(name: URLQueryParams.event, value: eventString.stringByAddingPercentEncoding),
                ]
            }
            
            return [
                URLQueryItem(name: URLQueryParams.siteId, value: siteId.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.userId, value: userId?.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.adId, value: adId?.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.url, value: (url?.absoluteString.decodeUrl())?.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.urlReferer, value: (urlReferer?.absoluteString.decodeUrl())?.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.language, value: language?.addingPercentEncoding(withAllowedCharacters: .alphanumerics)?.stringByAddingPercentEncoding),
                URLQueryItem(name: URLQueryParams.clientDateTime, value: CommonUtil.Formatter.iso8601DateFormatter.string(from: clientDateTime)),
                URLQueryItem(name: URLQueryParams.screenSize, value: String(format: "%1.0fx%1.0f", screenResolution.width, screenResolution.height)),
                URLQueryItem(name: URLQueryParams.event, value: (serializeEventString() + "‚àû" + "obz_unsent‚â°1").stringByAddingPercentEncoding)
            ]
        }
    }
}

fileprivate extension CharacterSet {
    
    /// URLQuery ÌååÎùºÎØ∏ÌÑ∞Ïóê ÌóàÏö©ÎêòÎäî ÌäπÏàòÎ¨∏ÏûêÎ•º Î∞òÌôòÌï©ÎãàÎã§.
    static var urlQueryParameterAllowed: CharacterSet {
        return CharacterSet.urlQueryAllowed.subtracting(CharacterSet(charactersIn: ###"&/?;',+"!^()=@*$"###))
    }
}
